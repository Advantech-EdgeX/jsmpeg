<!DOCTYPE html>
<html>
<head>
	<title>JSMpeg Stream Client</title>

    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <script src="mqttws31.js" type="text/javascript"></script>
    <script src="jquery.min.js" type="text/javascript"></script>
    <script src="config.js" type="text/javascript"></script>

    <script type="text/javascript">
    var mqtt;
     var reconnectTimeout = 2000;
     var mqtt_msg_ary = [];
     var mqtt_msg_ary_idx = 0;

    function MQTTconnect() {
	if (typeof path == "undefined") {
		path = '/mqtt';
	}
	mqtt = new Paho.MQTT.Client(
			host,
			port,
			path,
			"web_" + parseInt(Math.random() * 100, 10)
	);
        var options = {
            timeout: 3,
            useSSL: useTLS,
            cleanSession: cleansession,
            onSuccess: onConnect,
            onFailure: function (message) {
                $('#status').val("Connection failed: " + message.errorMessage + "Retrying");
                setTimeout(MQTTconnect, reconnectTimeout);
            }
        };

        mqtt.onConnectionLost = onConnectionLost;
        mqtt.onMessageArrived = onMessageArrived;

        if (username != null) {
            options.userName = username;
            options.password = password;
        }
        console.log("Host="+ host + ", port=" + port + ", path=" + path + " TLS = " + useTLS + " username=" + username + " password=" + password);
        mqtt.connect(options);
    }

    function onConnect() {
        $('#status').val('Connected to ' + host + ':' + port + path);
        // Connection succeeded; subscribe to our topic
        mqtt.subscribe(topic, {qos: 0});
        $('#topic').val(topic);
    }

    function onConnectionLost(response) {
        setTimeout(MQTTconnect, reconnectTimeout);
        $('#status').val("connection lost: " + responseObject.errorMessage + ". Reconnecting");

    };

    function onMessageArrived(message) {

        var topic = message.destinationName;
         var payload = message.payloadString;
         var p = payload.slice();
         var o = JSON.parse(p);
         //$('#ws').prepend('<li>' + topic + ' = ' + payload + '</li>');
         //$('#ws').replaceWith('<text id=ws>' + payload + '</text>');
         var d = o.objects.toString();
         var ts = o.timestamp.toString();
         var dd = d.replace(/\|/g, '-');
         var data = ts + " " + dd;
         var len = mqtt_msg_ary.push(data);
         if (len > 30) {
             var x = mqtt_msg_ary.toString();
             var xx = x.replaceAll(",", "<br />");
            $('#ws').replaceWith('<text id=ws>' + xx + '</text>');
            mqtt_msg_ary = [];
         }
    };


    $(document).ready(function() {
        MQTTconnect();
    });

    </script>

	  <script type="text/javascript" src="jsmpeg.min.js"></script>
</head>
<body>
    <table><tr><td>
  <canvas id="video-canvas" style="width:1024px"></canvas>
	<script type="text/javascript">
		var canvas = document.getElementById('video-canvas');
    var url = 'ws://'+document.location.hostname+':8082/';
		var player = new JSMpeg.Player(url, {canvas: canvas});
	</script>
  </td><td>
      <text id='ws' style="font-family: 'Courier New', Courier, monospace;"></text>
      </td></tr></table>
</body>
</html>
